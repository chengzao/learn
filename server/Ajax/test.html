<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Ajax</title>
	<style>
		p {
			text-align: center;
			font-size: 24px;
		}
	</style>
</head>
<body>
	<p>封装Ajax工具函数</p>
	<script>
		// 封装一个函数
		// 传统方式传参不方便
		// function ajax(type, url, data, callback) {
		// 	var xhr = new XMLHttpRequest;
		// }

		var options = {       
			type: '',
			url: '',
			// data: {},
			callback: function () {}
		}

		// 我传递一个对象，会更加灵活
		function ajax(options) {
			var xhr = new XMLHttpRequest;

			var url = options.url;
			var type = options.type;
			var data = options.data || null;
			var callback = options.callback;
		}

		// 专业术语 变量污染 命名冲突

		// 命名空间
		var utils = {
			name: 'abc',
			ajax: function () {

			}
		}

		// 1、通过对象传参的方式传递参数
		// 2、采用命名空间避免污染

		var $ = {
			param: function (arg) {
				// 将对象转化成请求主体需要的数据格式
				// name=xiaoming&age=10&
				var str = '';
				for(var key in arg) {
					str += key + '=' + arg[key] + '&';
				}

				// 截取最后一个&
				str = str.slice(0, -1);

				return str;

				// console.log(str);
			},
			createXHR:function(){
				if (typeof XMLHttpRequest != "undefined") {
					return new XMLHttpRequest();
				} else if (typeof ActiveXObject != "undefined") {
					if (typeof arguments.callee.activeXString != "string") {
						var versions = ["MSXML2.XMLHttp.6.0", "MSXML2.XMLHttp.3.0",
								"MSXML2.XMLHttp"
							],
							i, len;

						for (i = 0, len = versions.length; i < len; i++) {
							try {
								new ActiveXObject(versions[i]);
								arguments.callee.activeXString = versions[i];
								break;
							} catch (ex) {
								//skip
							}
						}
					}
					return new ActiveXObject(arguments.callee.activeXString);
				} else {
					throw new Error("No XHR object available.");
				}		
			},
			strToJson:function(str){
				var json = (new Function("return " + str))(); 
				return json;				
			},			
			ajax: function (options) {
				var url = options.url || location.pathname;
				var type = options.type || 'get';
				// data 的格式key1=val1&key2=val2&key3=val3
				var data = this.param(options.data);

				//var xhr = new XMLHttpRequest;
				var xhr = this.createXHR();
				// get方式参数放在url后拼接?
				if(type == 'get') {
					url = url + '?' + data;
					data = null;
				}
				var _this=this;
				// 请求行
				xhr.open(type, url);

				// post设置请求头
				if(type == 'post') {
					xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				}

				// 请求主体
				xhr.send(data);

				// 监听返回状并处理
				xhr.onreadystatechange = function () {
					if(xhr.readyState == 4 && xhr.status == 200) {
						var ct = xhr.getResponseHeader('Content-Type');
						//console.log(ct);

						if(ct.indexOf('json') != -1) {
							// 检测是否是一个json返回
							var result = xhr.responseText;

							// 解析
							// result = JSON.parse(result);
							result = _this.strToJson(result);
							options.success(result);
						} else {
							options.error('必须要返回一个json格式');
						}
					}
				}
			}
		}


		$.ajax({
			url: 'stars.php?name=xiaoming',
			type: 'GET',
			data: {},
			success: function (data) {
				console.log(data);
			},
			error: function (err) {
				alert(err);
			}
		});

		$.ajax({
			url: 'stars.php',
			type: 'POST',
			data: {'name':'xiaowang','age':33},
			success: function (data) {
				console.log(data);
			},
			error: function (err) {
				alert(err);
			}
		});		

		// function strToJson(str){ 
		// var json = (new Function("return " + str))(); 
		// return json; 
		// } 

		// 
		// var obj = {
		// 	name: 'xiaoming',
		// 	sayName: function () {
		// 		console.log(this.name);
		// 	}
		// }

		// obj.sayName();
	



		/*******************************************************/

		// 可以跳转地址
		// window.location.href = 'http://www.baidu.com';

		// 主机
		// console.log(location.host);

		// 获取路径
		// console.log(location.pathname);

		// 获取hash值，当前处于哪个锚点上
		// console.log(location.hash);

		// 获取协议
		// console.log(location.protocol);

		// 总结 location 是可以获取 当前 url 的相关信息的一个内置对象

		// for(var k in location) {
		// 	console.log(k);
		// }

	</script>
</body>
</html>